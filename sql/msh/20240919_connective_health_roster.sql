DROP TABLE IF EXISTS _pats;
CREATE TEMP TABLE _pats AS
SELECT DISTINCT on (p.first_name, p.id)
    mp.first_name          "ProviderFirstName"
  , mp.last_name           "ProviderLastName"
  , mp.npi                 "NPI"
  , rp.name                "ProviderClinicName"
  , rp.npi                 "ClinicNpi"
  , p.first_name           "FirstName"
  , p.last_name            "LastName"
  , p.dob                  "Date Of Birth"
  , LEFT(p.gender, 1)      "Gender"
  , pa.line1               "Address1"
  , pa.line2               "Address2"
  , pa.city                "City"
  , pa.state               "State"
  , pa.postal_code         "Zip"
  , cp_home.phone_number   "HOME"
  , cp_mobile.phone_number "MOBILE"
  , sp.patient_id
FROM
    supreme_pizza sp
    JOIN patients p ON sp.patient_id = p.id
    left JOIN msh_physicians mp ON sp.primary_physician_id = mp.id
    left JOIN referring_partners rp ON rp.id = sp.primary_referring_partner_id
    left JOIN patient_addresses pa ON p.id = pa.patient_id
    left JOIN patient_contact_phones pcp_home ON p.id = pcp_home.patient_id
        AND pcp_home."primary"
    left JOIN contact_phones cp_home ON cp_home.id = pcp_home.contact_phone_id
        AND cp_home.status = 'active'::TEXT
        AND cp_home.type = 'home'
    LEFT JOIN patient_contact_phones pcp_mobile ON p.id = pcp_mobile.patient_id
    LEFT JOIN contact_phones cp_mobile ON cp_mobile.id = pcp_mobile.contact_phone_id
        AND cp_mobile.status = 'active'::TEXT
        AND cp_mobile.type = 'mobile'
WHERE
    p.id in (
       881922,1209770,881756,1165864,1209461,866931,1210907,1210344,1209647,1455446,1310568,1209062,962300,887784,1209718,1355716,1355695,1177906,1170048,1115163,1119706,957216,873217,851763,1442589,975168,1355822,1118056,1118213,854023,957750,1179924,889667,1460157,1210334,856593,974144,1355968,1183673,1198684,1451673,1169434,1355536,1177486,1210994,1355744,1124905,1119218,851713,867473,890415,974138,1125194,887837,866860,856298,1191817,866871,1160748,957880,1355624,1317852,1118705,856401,1487840,881842,873388,1241225,1180685,932279,875172,1455313,1120970,1116984,957264,1124002,851577,1362331,1245640,1192522,1209193,1208493,1355828,1184629,1310571,866731,1211143,1454763,852399,1184288,889788,856847,852989,1355975,1209636,974834,1468039,1442533,1119334,942601,1343592,1098741,1090965,1164515,957390,1210613,853748,1409720,1187726,1170230,1454115,854444,932394,1480362,1209469,1474349,1401164,1209811,1355665,1123805,1199715,1355659,854094,1211198,1175678,1208536,974163,857289,974370,1124601,894235,1483330,1209272,1195947,1123161,1118318,1178377,853614,878651,1210357,1209837,1176580,1210340,889676,1355843,852380,1191602,1355838,1167739,855267,1468036,852666,1198058,1419613,1077913,731902,1209561,887742,1355608,921871,974333,851772,851592,1277526,1442136,1420532,1425515,1390996,1208537,854281,1116245,957594,1209541,1355888,1447778,1355957,1451668,1455248,1483309,957367,1162097,881948,1200574,1162853,1119291,932221,1355623,854654,1180870,881740,957425,853559,974919,871982,1181256,855724,871972,1171439,1355931,1454112,1117769,895521,1483744,1211057,1355795,1355724,1171323,1200308,1117506,1345821,1027823,1483980,1180172,1118237,974753,1209278,1208916,1182698,1117505,1442098,974929,1467252,1209803,1211080,1172002,1081231,1209123,1355897,1212134,1210540,974381,1483735,1187484,1188755,1455470,1053945,1208738,873223,1212122,1209480,1455407,1171087,975051,856974,873303,1192963,967481,957054,887738,855064,1209776,895543,1124492,1478798,1193241,957469,1210921,1176173,1355912,1208871,1168918,1358758,923611,855907,1173546,1195488,1174656,1355772,918727,1355769,1483733,1443398,1187302,1172836,974510,1208863,872576,856811,1193946,881895,1122850,1174606,1355595,1259099,1003837,1124590,957211,1117702,866693,867481,1194105,1119518,1123548,957003,853558,1218106,1212078,1208586,882051,1166187,1210365,1209238,1210445,1355625,855673,1124695,866678,1383794,922637,1189210,1123045,854470,866947,1355983,855383,1165265,852663,957577,1355602,974196,866743,1476650,1116059,1177373,1210964,1171995,882054,1355640,1208643,1172446,1191206,881939,1192084,1309929,1159454,866724,1483432,881973,887731,1051075,1455286,853585,1208817,1185362,1209358,1442454,1094598,1117387,1245849,1174151,1210517,895513,1355507,1469126,1174288,974750,1355534,1355911,1211192,1123824,1172178,974867,1160412,1355686,1182036,1474821,1355548,1208720,1125018,892892,1209101,1212065,857234,1210883,1209505,889744,1210612,1119699,1103102,1429906,1442460,1355765,1123334,932248,1170871,853198,1119425,854454,1194612,1209523,1182404,854951,854020,1211228,1168503,957503,889525,857263,1481788,887893,1476986,1182645,407308,407394,407595,407870,408002,410799,410811,410882,411064,411121,411497,411509,411638,411650,411653,411832,411868,411909,414733,414873,415131,415237,415310,415329,415385,415417,415518,415573,415678,415679,501157,501159,504759,512825,649640,649644,841906,860106,874841,878884,882463,925136,957865,958538,1028376,1081190,1114918,1114954,1114958,1114969,1115014,1115018,1115045,1115138,1118708,1118814,1119407,1119877,1124101,1124195,1124280,1124371,1125007,1125097,1125112,1130506,1163819,1164737,1175705,1176226,1177436,1183406,1190115,1190128,1198467,1198723,1201897,1209303,1209338,1210529,1210681,1210757,1210791,1217238,1246632,1246633,1317573,1317574,1373778,1389546,1389553,1405045,1409692,1416870,1417048,1421619,1425646,1429848,1430626,1444108,1447698,1447699,1448245,1448249,1456326,1456329,1467950,1473200,1478738,1479216,1483001,1483002,1483442,1483518,1483698,1483700,1483707,1483927,1483928,1483934,1483950,1483952,1483955,1483967,1483976,1483977,1483979,1483984,1483998,1483999,1484005,1484023,1484037,1484040,1484055,1484068,1484075,1484076,1484086,1484097,1484114,1484120,1484126,1484131,405850,406014,407135,406177,406769,409655,409691,409705,409718,409757,410426,410605,410710,410747,410753,413275,413487,413495,413678,413800,413856,413916,467108,474994,488219,543907,550528,573744,651714,678415,752668,752683,752687,868992,868994,873228,892821,920662,932937,932941,936121,965794,966135,1115095,1118015,1118060,1118235,1118539,1118618,112131,112219,112228,112229,112264,112291,112364,112402,112419,112421,112457,112467,112493,112506,112587,112592,112674,112808,112817,112821,112892,112967,112983,113018,113024,113046,113069,113071,113098,113135,115249,115252,115306,115309,115310,115337,115394,115440,115445,115459,115562,115587,115639,115644,115652,115727,115884,115907,115982,115984,116007,116025,116083,116102,116108,116159,116178,116189,116203,116239,116250,140920,266807,283876,288026,317327,317601,318113,318368,336554,336558,336581,336713,336716,345439,345445,348766,360375,367268,402689,417666,432169,586374,620012,887328,887348,887369,887376,887377,887381,887417,887431,887433,887458,887460,887466,887499,887506,887510,887531,887551,887577,887607,887623,887624,887633,887637,887639,887666,921666,924611,929413,929562,929588,941924,942046,955292,962433,967046,967652,1027709,1050442,1050986,1088712,1095581,1095618,1115813,1115822,1159652,1182681,1192296,1209676,1209685,1209751,1209810,1210470,1210481,1210572,1210673,1210712,1210750,1283874,1343751,1343761,1355702,1355720,1355788,1355836,1355861,1355868,1355889,1356015,1404749,1416368,1424520,1429144,1446131,1447450,1447456,1447481,1455222,1466787,1466846,1472219,1475357,1475833,1476253,1476287,1476336,1480700,1480720,1480742,1484267,1484291,1484311,1484355,1484379,1484397,1484407,1484418,1484583,1484602,1485615,1485673,1485724,1485774,1485858,1489357,110695,110707,110731,110757,110765,110852,110878,110910,113558,110949,110972,111028,111030,111063,111064,113157,113321,113323,113412,113399,113435,113449,113488,113502,113506,113520,113528,113584,113603,113661,113689,113725,113742,113753,113775,113802,113860,113869,113917,113968,113978,113979,114000,114018,114019,114032,114033,114040,114066,114067,114090,114149,114167,116295,116299,116339,116405,116435,116463,116485,116500,116507,116523,116524,116535,116625,116633,116742,116874,116953,116986,117144,117155,117189,117225,117229,117231,117248,117278,117284,121295,121360,121364,121382,121404,121430,308401,320084,320502,320508,321010,335173,335439,335619,336116,452950,452951,452966,453027,453099,453105,453169,453201,453220,453253,453281,732855,880756,1091333,1103176,1194036,1209424,1209537,1209754,1210490,1210640,454543,454551,454555,454571,454573,454598,454616,454674,454705,502377,771945,955469,955472,963776,967913,973075,1115914,1115998,1116039,1116208,1116246,1180925,1209848,1210944,1211345,1212077,1272544,1277747,1407119,453380,453401,453436,453453,453466,453512,453536,453545,453631,453649,453665,453674,453682,453710,453715,453774,453795,453803,453851,453925,453940,453979,453985,454006,454076,454081,454091,454093,454095,454099,454105,454110,454113,454137,454139,454168,454172,454192,454194,454198,454204,454228,454321,454337,454387,454415,454418,454444,454463,454472,454526,454535,482928,716235,716236,871476,896178,927806,1118413,1164248,1170858,1177607,1208595,1208634,1208842,1208996,1283895,1288104,1320564,1320578,1483036,1488864
        )
order by p.first_name, p.id
;

-- demographics
-- connective_health_demographics_20240919
SELECT * FROM _pats;

-- diagnoses
-- connective_health_diagnoses_20240919
SELECT
    p."FirstName"
  , p."LastName"
  , i.code_formatted                                             "ICD 10 Code"
  , i.short_description                                          "Display Value"
  , COALESCE(meed.plan_capture_date, meed.practice_capture_date) "Date"
  , p.patient_id
FROM
    _pats p
    JOIN msh_external_emr_diagnoses meed ON p.patient_id = meed.patient_id
    JOIN icd10s i ON meed.icd10_id = i.id
    LEFT JOIN visits v ON v.patient_id = meed.patient_id AND v.type_id = 'cca_recon'::TEXT AND
                          v.deleted_at IS NULL AND
                          DATE_PART('year'::TEXT, v.date) = meed.cms_contract_year::DOUBLE PRECISION
    LEFT JOIN msh_cca_worksheets mcw ON mcw.visit_id = v.id
    LEFT JOIN msh_cca_worksheet_dxs dx_1
              ON dx_1.msh_cca_worksheet_id = mcw.id AND dx_1.icd10_id = i.id
WHERE
     meed.plan_capture_date IS NOT NULL
  OR meed.practice_capture_date IS NOT NULL
         AND NOT meed.is_deleted
         AND (meed.diagnosis_type = 'recapture'::TEXT OR
              CASE
                  WHEN dx_1.code_status = 'checked_in_worksheet'::TEXT THEN 'checked_yes_on_worksheet'::TEXT
                  ELSE dx_1.code_status
                  END = 'checked_yes_on_worksheet'::TEXT)





;